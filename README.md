# HTTPS Proxy with Authelia MFA

ä¸€ä¸ªå®‰å…¨çš„ HTTPS åå‘ä»£ç†æœåŠ¡ï¼Œå°†æœ¬åœ° HTTP æœåŠ¡é€šè¿‡ HTTPS æš´éœ²åˆ°æ‰€æœ‰ç½‘å¡ï¼Œé›†æˆ Authelia MFA éªŒè¯ã€‚

## åŠŸèƒ½ç‰¹æ€§

- å°†ä»»æ„ç«¯å£çš„ HTTP localhost æœåŠ¡ä»£ç†åˆ° HTTPS (port+1)
- åŸºäºç¯å¢ƒå˜é‡çš„ç”¨æˆ·è®¤è¯ (user:password_hash)
- é›†æˆ Authelia MFA éªŒè¯ç•Œé¢
- å®Œæ•´çš„è®¿é—®æ—¥å¿—è®°å½•
- æ”¯æŒ SSL è¯ä¹¦è‡ªåŠ¨æ›´æ–° (é€šè¿‡ Docker å·æŒ‚è½½)
- ç»‘å®šæ‰€æœ‰ç½‘å¡æ¥å£

## å¿«é€Ÿå¼€å§‹

```bash
# æ„å»ºé•œåƒ
docker build -t https-proxy .

# è¿è¡ŒæœåŠ¡
docker run -d \
  -p 8081:8081 \
  -e HTTP_PORT=8080 \
  -e USER_CREDENTIALS="admin:$2a$10$..." \
  -v ./certs:/app/certs \
  -v ./logs:/app/logs \
  --name https-proxy \
  https-proxy
```

## ç¯å¢ƒå˜é‡

- `HTTP_PORT`: è¦ä»£ç†çš„æœ¬åœ° HTTP ç«¯å£ (é»˜è®¤: 8080)
- `USER_CREDENTIALS`: ç”¨æˆ·è®¤è¯ä¿¡æ¯ï¼Œæ ¼å¼: "username:bcrypt_hash"
- `SESSION_SECRET`: ä¼šè¯å¯†é’¥ (å¯é€‰ï¼Œè‡ªåŠ¨ç”Ÿæˆ)
##
 é¡¹ç›®ç»“æ„

```
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ server.js           # ä¸»æœåŠ¡å™¨æ–‡ä»¶
â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â””â”€â”€ auth.js         # è®¤è¯ä¸­é—´ä»¶
â”‚   â””â”€â”€ utils/
â”‚       â””â”€â”€ logger.js       # æ—¥å¿—å·¥å…·
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ generate-certs.sh   # ç”Ÿæˆ SSL è¯ä¹¦è„šæœ¬
â”‚   â””â”€â”€ generate-password.js # ç”Ÿæˆå¯†ç å“ˆå¸Œè„šæœ¬
â”œâ”€â”€ example-content/        # ç¤ºä¾‹å†…å®¹
â”œâ”€â”€ certs/                  # SSL è¯ä¹¦ç›®å½• (éœ€è¦æŒ‚è½½)
â”œâ”€â”€ logs/                   # æ—¥å¿—ç›®å½•
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ docker-compose.yml
â””â”€â”€ package.json

## éƒ¨ç½²æ­¥éª¤

### 1. ç”Ÿæˆç”¨æˆ·å¯†ç å“ˆå¸Œ

```bash
npm install
node scripts/generate-password.js
```

### 2. å‡†å¤‡ SSL è¯ä¹¦

#### å¼€å‘ç¯å¢ƒ (è‡ªç­¾åè¯ä¹¦)
```bash
./scripts/generate-certs.sh
```

#### ç”Ÿäº§ç¯å¢ƒ (æ¨èä½¿ç”¨ Let's Encrypt)
```bash
# å°†è¯ä¹¦æ–‡ä»¶æ”¾ç½®åˆ° certs ç›®å½•
cp /path/to/your/cert.pem ./certs/
cp /path/to/your/key.pem ./certs/
```

### 3. é…ç½®ç¯å¢ƒå˜é‡

```bash
cp .env.example .env
# ç¼–è¾‘ .env æ–‡ä»¶ï¼Œè®¾ç½®æ­£ç¡®çš„ç”¨æˆ·å‡­æ®
```

### 4. å¯åŠ¨æœåŠ¡

#### ä½¿ç”¨ Docker Compose (æ¨è)
```bash
docker-compose up -d
```

#### ä½¿ç”¨ Docker
```bash
docker build -t https-proxy .
docker run -d \
  --network host \
  -e HTTP_PORT=8080 \
  -e USER_CREDENTIALS="admin:$2a$10$..." \
  -v $(pwd)/certs:/app/certs:ro \
  -v $(pwd)/logs:/app/logs \
  --name https-proxy \
  https-proxy
```

## ä½¿ç”¨è¯´æ˜

1. å¯åŠ¨ä½ çš„ HTTP æœåŠ¡åœ¨ç«¯å£ 8080
2. å¯åŠ¨ HTTPS ä»£ç†æœåŠ¡
3. è®¿é—® `https://your-server:8081`
4. ä½¿ç”¨é…ç½®çš„ç”¨æˆ·åå’Œå¯†ç ç™»å½•
5. æˆåŠŸè®¤è¯åå³å¯è®¿é—®ä»£ç†çš„æœåŠ¡

## æ—¥å¿—æ–‡ä»¶

- `logs/access.log` - è®¿é—®æ—¥å¿—
- `logs/error.log` - é”™è¯¯æ—¥å¿—
- `logs/debug.log` - è°ƒè¯•æ—¥å¿— (ä»…å¼€å‘ç¯å¢ƒ)

## å®‰å…¨ç‰¹æ€§

- HTTPS å¼ºåˆ¶åŠ å¯†
- bcrypt å¯†ç å“ˆå¸Œ
- ä¼šè¯ç®¡ç†
- é€Ÿç‡é™åˆ¶
- å®‰å…¨å¤´éƒ¨ (Helmet)
- è¯¦ç»†çš„è®¿é—®æ—¥å¿—
- MFA é£æ ¼çš„ç™»å½•ç•Œé¢

## è¯ä¹¦è‡ªåŠ¨æ›´æ–°

é€šè¿‡ Docker å·æŒ‚è½½è¯ä¹¦ç›®å½•ï¼Œå¯ä»¥å®ç°è¯ä¹¦çš„è‡ªåŠ¨æ›´æ–°ï¼š

```bash
# ä½¿ç”¨ certbot è‡ªåŠ¨æ›´æ–°è¯ä¹¦
certbot renew --deploy-hook "docker restart https-proxy"
```## ç½‘
ç»œæ¨¡å¼è¯´æ˜

### å®¿ä¸»æœºç½‘ç»œæ¨¡å¼ (æ¨è)

é¡¹ç›®é»˜è®¤ä½¿ç”¨ `network_mode: host`ï¼Œè¿™æ ·ä»£ç†å®¹å™¨å¯ä»¥ç›´æ¥è®¿é—®å®¿ä¸»æœºä¸Šè¿è¡Œçš„æœåŠ¡ï¼š

**ä¼˜ç‚¹:**
- ç›´æ¥è®¿é—®å®¿ä¸»æœºä¸Šçš„ä»»ä½•ç«¯å£æœåŠ¡
- æ— éœ€ç«¯å£æ˜ å°„ï¼Œæ€§èƒ½æ›´å¥½
- é€‚åˆä»£ç†ç°æœ‰çš„å®¿ä¸»æœºæœåŠ¡

**ä½¿ç”¨åœºæ™¯:**
```bash
# å®¿ä¸»æœºä¸Šè¿è¡Œçš„æœåŠ¡
python -m http.server 8080  # æˆ–ä»»ä½•å…¶ä»–æœåŠ¡

# ä»£ç†å®¹å™¨ä¼šè‡ªåŠ¨ä»£ç†åˆ° https://0.0.0.0:8081
docker-compose up -d
```

### æ¡¥æ¥ç½‘ç»œæ¨¡å¼ (å¯é€‰)

å¦‚æœéœ€è¦ä½¿ç”¨æ¡¥æ¥ç½‘ç»œï¼Œå¯ä»¥ä¿®æ”¹ `docker-compose.yml`:

```yaml
services:
  https-proxy:
    build: .
    ports:
      - "8081:8081"
    networks:
      - proxy-network
    # ç§»é™¤ network_mode: host
```

ä½†è¿™ç§æ¨¡å¼ä¸‹ï¼Œéœ€è¦ä½¿ç”¨ `host.docker.internal` æ¥è®¿é—®å®¿ä¸»æœºæœåŠ¡ï¼š

```javascript
// åœ¨ server.js ä¸­ä¿®æ”¹ä»£ç†ç›®æ ‡
target: `http://host.docker.internal:${HTTP_PORT}`
```## 
çœŸæ­£çš„å¤šå› ç´ è®¤è¯ (MFA)

é¡¹ç›®ç°åœ¨é›†æˆäº†çœŸæ­£çš„ MFA æ”¯æŒï¼Œç±»ä¼¼ Autheliaï¼š

### MFA åŠŸèƒ½ç‰¹æ€§

- **TOTP æ”¯æŒ**: å…¼å®¹ Google Authenticatorã€Authyã€1Password ç­‰
- **QR ç è®¾ç½®**: é¦–æ¬¡ç™»å½•æ—¶è‡ªåŠ¨å¼•å¯¼è®¾ç½® MFA
- **å®‰å…¨å­˜å‚¨**: MFA å¯†é’¥é€šè¿‡ç¯å¢ƒå˜é‡æŒä¹…åŒ–
- **æ—¶é—´çª—å£**: æ”¯æŒå‰å2ä¸ªæ—¶é—´çª—å£çš„ä»¤ç‰ŒéªŒè¯
- **å®Œæ•´æ—¥å¿—**: è®°å½•æ‰€æœ‰ MFA ç›¸å…³æ“ä½œ

### MFA è®¾ç½®æµç¨‹

1. **é¦–æ¬¡ç™»å½•**: è¾“å…¥ç”¨æˆ·åå’Œå¯†ç 
2. **MFA è®¾ç½®**: æ‰«æ QR ç ï¼Œæ·»åŠ åˆ°è®¤è¯å™¨åº”ç”¨
3. **éªŒè¯è®¾ç½®**: è¾“å…¥6ä½æ•°å­—ç å®Œæˆè®¾ç½®
4. **åç»­ç™»å½•**: å¯†ç  + 6ä½æ•°å­—ç 

### æ”¯æŒçš„è®¤è¯å™¨åº”ç”¨

- Google Authenticator
- Microsoft Authenticator  
- Authy
- 1Password
- Bitwarden
- ä»»ä½•æ”¯æŒ TOTP çš„åº”ç”¨

### MFA ç®¡ç†

#### å¯¼å‡º MFA å¯†é’¥ (å¤‡ä»½)
```bash
node scripts/export-mfa-secrets.js
```

#### é‡ç½®ç”¨æˆ· MFA
```javascript
// åœ¨ Node.js ç¯å¢ƒä¸­
const mfa = require('./src/utils/mfa');
mfa.resetMFA('username');
```

#### æŒä¹…åŒ– MFA è®¾ç½®
å°†å¯¼å‡ºçš„å¯†é’¥æ·»åŠ åˆ°ç¯å¢ƒå˜é‡ï¼š
```bash
MFA_SECRETS={"admin": "JBSWY3DPEHPK3PXP"}
```

### å®‰å…¨æ³¨æ„äº‹é¡¹

- MFA å¯†é’¥éå¸¸æ•æ„Ÿï¼Œè¯·å¦¥å–„ä¿ç®¡
- å»ºè®®å®šæœŸå¤‡ä»½ MFA å¯†é’¥
- å®¹å™¨é‡å¯ä¸ä¼šä¸¢å¤±å·²è®¾ç½®çš„ MFA
- æ”¯æŒå¤šç”¨æˆ·ï¼Œæ¯ä¸ªç”¨æˆ·ç‹¬ç«‹çš„ MFA è®¾ç½®#
# MFA æµ‹è¯•å·¥å…·

é¡¹ç›®åŒ…å«äº†å®Œæ•´çš„ MFA æµ‹è¯•å’ŒéªŒè¯å·¥å…·ï¼š

### ğŸ§ª äº¤äº’å¼ MFA æµ‹è¯•

```bash
# åŸºæœ¬æµ‹è¯• - ç”Ÿæˆ QR ç å’Œäº¤äº’å¼éªŒè¯
node scripts/test-mfa.js

# è‡ªåŠ¨åˆ·æ–°æ¼”ç¤º - è§‚å¯Ÿä»¤ç‰Œå˜åŒ–
node scripts/test-mfa.js --demo
```

**åŠŸèƒ½ç‰¹æ€§ï¼š**
- ğŸ“Š **ASCII QR ç **: åœ¨ç»ˆç«¯ä¸­æ˜¾ç¤ºå¯æ‰«æçš„ QR ç 
- â° **å®æ—¶æ—¶é—´ä¿¡æ¯**: UTC æ—¶é—´ã€æœ¬åœ°æ—¶é—´ã€å‰©ä½™æ—¶é—´
- ğŸ”¢ **å½“å‰ä»¤ç‰Œæ˜¾ç¤º**: æ˜¾ç¤ºæœŸæœ›çš„ 6 ä½æ•°å­—ç 
- ğŸ§ª **äº¤äº’å¼éªŒè¯**: è¾“å…¥ä»¤ç‰Œè¿›è¡Œå®æ—¶éªŒè¯æµ‹è¯•
- ğŸ”„ **è‡ªåŠ¨åˆ·æ–°**: è§‚å¯Ÿä»¤ç‰Œæ¯ 3 åˆ†é’Ÿçš„å˜åŒ–è¿‡ç¨‹

### âš¡ MFA æ€§èƒ½åŸºå‡†æµ‹è¯•

```bash
# è¿è¡Œæ€§èƒ½å’Œé€»è¾‘åŸºå‡†æµ‹è¯•
node scripts/mfa-benchmark.js
```

**æµ‹è¯•å†…å®¹ï¼š**
- ğŸš€ **æ€§èƒ½æµ‹è¯•**: ä»¤ç‰Œç”Ÿæˆå’ŒéªŒè¯é€Ÿåº¦
- â° **æ—¶é—´çª—å£æµ‹è¯•**: éªŒè¯ Â±6 åˆ†é’Ÿå®¹å·®
- ğŸ§¹ **è¾“å…¥æ¸…ç†æµ‹è¯•**: æµ‹è¯•ç©ºæ ¼å’Œç‰¹æ®Šå­—ç¬¦å¤„ç†
- ğŸ§ª **è¾¹ç•Œæƒ…å†µæµ‹è¯•**: æ— æ•ˆä»¤ç‰Œçš„æ­£ç¡®æ‹’ç»

### æµ‹è¯•ç”¨ä¾‹ç¤ºä¾‹

```bash
# 1. åŸºæœ¬åŠŸèƒ½æµ‹è¯•
$ node scripts/test-mfa.js
ğŸ” MFA Testing Script
=====================

ğŸ“± Generated Test Secret:
========================
Secret (Base32): JBSWY3DPEHPK3PXP
OTPAUTH URL: otpauth://totp/MFA%20Test%20(testuser)?secret=JBSWY3DPEHPK3PXP&issuer=HTTPS%20Proxy%20Test

ğŸ“Š QR Code (ASCII):
==================
â–ˆâ–€â–€â–€â–€â–€â–ˆ â–€â–„â–ˆâ–„â–€ â–ˆâ–€â–€â–€â–€â–€â–ˆ
â–ˆ â–ˆâ–ˆâ–ˆ â–ˆ â–ˆâ–ˆâ–€â–„â–ˆ â–ˆ â–ˆâ–ˆâ–ˆ â–ˆ
â–ˆ â–€â–€â–€ â–ˆ â–ˆâ–„â–€â–€â–„ â–ˆ â–€â–€â–€ â–ˆ
â–€â–€â–€â–€â–€â–€â–€ â–€ â–€ â–€ â–€â–€â–€â–€â–€â–€â–€

â° Current Time Information:
===========================
UTC Time: 2024-01-15T10:30:00.000Z
Time Step: 12345
Time Remaining: 2:30
Step Duration: 180 seconds (3 minutes)

ğŸ”¢ Current Expected Token:
==========================
Token: 123456
Valid for: 2:30 more

# 2. æ€§èƒ½åŸºå‡†æµ‹è¯•
$ node scripts/mfa-benchmark.js
ğŸš€ MFA Logic Benchmark
======================

âš¡ Token Generation Benchmark:
=============================
âœ… Generated 1000 tokens in 15.23ms
   Average: 0.0152ms per token

ğŸ” Token Verification Benchmark:
================================
âœ… Verified 1000 tokens in 28.45ms
   Average: 0.0285ms per verification
   Valid tokens: 1000/1000 (100.0%)

â° Time Window Tolerance Test:
==============================
Window -2: 654321 (-360s, 6min) â†’ âœ… VALID
Window -1: 789012 (-180s, 3min) â†’ âœ… VALID
Window  0: 123456 (+0s, 0min) â†’ âœ… VALID
Window  1: 456789 (+180s, 3min) â†’ âœ… VALID
Window  2: 987654 (+360s, 6min) â†’ âœ… VALID
```

### éªŒè¯ MFA é€»è¾‘

è¿™äº›æµ‹è¯•å·¥å…·å¸®åŠ©éªŒè¯ï¼š
- âœ… **3 åˆ†é’Ÿé—´éš”**: ä»¤ç‰Œæ¯ 3 åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡
- âœ… **æ—¶é—´å®¹å·®**: Â±6 åˆ†é’Ÿçš„éªŒè¯çª—å£
- âœ… **UTC æ—¶é—´**: ä½¿ç”¨ UTC é¿å…æ—¶åŒºé—®é¢˜
- âœ… **è¾“å…¥æ¸…ç†**: æ­£ç¡®å¤„ç†ç©ºæ ¼å’Œç‰¹æ®Šå­—ç¬¦
- âœ… **æ€§èƒ½è¡¨ç°**: æ¯«ç§’çº§çš„ç”Ÿæˆå’ŒéªŒè¯é€Ÿåº¦## MFA æ•°
æ®æŒä¹…åŒ–

MFA è®¾ç½®ç°åœ¨ä¼šè‡ªåŠ¨æŒä¹…åŒ–åˆ°æ–‡ä»¶ç³»ç»Ÿï¼Œç¡®ä¿å®¹å™¨é‡å»ºåä¸ä¼šä¸¢å¤±ï¼š

### ğŸ“ æ•°æ®å­˜å‚¨

```
data/
â””â”€â”€ mfa-secrets.json    # MFA å¯†é’¥å­˜å‚¨æ–‡ä»¶ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
```

### ğŸ”„ æŒä¹…åŒ–æœºåˆ¶

- **è‡ªåŠ¨ä¿å­˜**: ç”¨æˆ·å®Œæˆ MFA è®¾ç½®æ—¶è‡ªåŠ¨ä¿å­˜åˆ°æ–‡ä»¶
- **å¯åŠ¨åŠ è½½**: å®¹å™¨å¯åŠ¨æ—¶è‡ªåŠ¨ä»æ–‡ä»¶åŠ è½½å·²æœ‰çš„ MFA è®¾ç½®
- **Docker å·**: é€šè¿‡ Docker å·ç¡®ä¿æ•°æ®åœ¨å®¹å™¨é‡å»ºåä¿æŒ
- **åŒé‡æ¥æº**: æ”¯æŒä»æ–‡ä»¶å’Œç¯å¢ƒå˜é‡åŠ è½½ï¼ˆç¯å¢ƒå˜é‡ä¼˜å…ˆï¼‰

### ğŸ› ï¸ ç®¡ç†å‘½ä»¤

#### æŸ¥çœ‹å½“å‰ MFA çŠ¶æ€
```bash
curl http://localhost:8081/auth/mfa-debug
```

#### é‡ç½®ç”¨æˆ· MFAï¼ˆå¼€å‘ç¯å¢ƒï¼‰
```bash
curl -X POST -d "username=admin" http://localhost:8081/auth/mfa-reset
```

#### æ¸…ç†ä¸´æ—¶è®¾ç½®ä¼šè¯
```bash
curl -X POST -d "username=admin" http://localhost:8081/auth/mfa-cleanup
```

### ğŸ“‹ æ•°æ®æ–‡ä»¶æ ¼å¼

`data/mfa-secrets.json` æ–‡ä»¶æ ¼å¼ï¼š
```json
{
  "admin": "JBSWY3DPEHPK3PXP",
  "user2": "KBSWY3DPEHPK3PXQ"
}
```

### ğŸ”’ å®‰å…¨æ³¨æ„äº‹é¡¹

- **å¤‡ä»½é‡è¦**: å®šæœŸå¤‡ä»½ `data/mfa-secrets.json` æ–‡ä»¶
- **æƒé™æ§åˆ¶**: ç¡®ä¿æ•°æ®ç›®å½•åªæœ‰å®¹å™¨å¯ä»¥è®¿é—®
- **åŠ å¯†å­˜å‚¨**: ç”Ÿäº§ç¯å¢ƒå»ºè®®å¯¹æ•°æ®ç›®å½•è¿›è¡ŒåŠ å¯†
- **è®¿é—®æ—¥å¿—**: æ‰€æœ‰ MFA æ“ä½œéƒ½ä¼šè®°å½•åˆ°æ—¥å¿—ä¸­

### ğŸš€ å®¹å™¨é‡å»ºæµç¨‹

```bash
# 1. åœæ­¢å®¹å™¨ï¼ˆæ•°æ®ä¼šä¿ç•™åœ¨ ./data ç›®å½•ï¼‰
docker-compose down

# 2. é‡å»ºé•œåƒ
docker-compose build

# 3. å¯åŠ¨å®¹å™¨ï¼ˆè‡ªåŠ¨åŠ è½½å·²æœ‰çš„ MFA è®¾ç½®ï¼‰
docker-compose up -d

# 4. éªŒè¯ MFA æ•°æ®å·²åŠ è½½
curl http://localhost:8081/auth/mfa-debug
```

ç”¨æˆ·æ— éœ€é‡æ–°è®¾ç½® MFAï¼Œæ‰€æœ‰è®¤è¯å™¨åº”ç”¨ä¸­çš„é…ç½®ç»§ç»­æœ‰æ•ˆã€‚